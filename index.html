<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Расписание</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/schedule-api.js"></script>
    <script src="js/samples.js"></script>
</head>

<body>
    <div class="container">
        <div class="edit-interface">
            <form>
                <strong>расписание в заданный интервал</strong>
                <br> аудитория
                <br>
                <select id="auditoriumSelect"></select>
                <br> начало:
                <br>
                <select id="startDay">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
                <select id="startMonth">
                    <option value="jan">январь</option>
                    <option value="feb">февраль</option>
                    <option value="mar">март</option>
                    <option value="apr">апрель</option>
                    <option value="may">май</option>
                    <option value="jun">июнь</option>
                    <option value="jul">июль</option>
                    <option value="aug">август</option>
                    <option value="sep">сентябрь</option>
                    <option value="oct">октябрь</option>
                    <option value="nov">ноябрь</option>
                    <option value="dec">декабрь</option>
                </select>
                <select id="startYear">
                    <option value="2015">2015</option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                </select>
                <br>конец:
                <br>
                <select id="endDay">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
                <select id="endMonth">
                    <option value="jan">январь</option>
                    <option value="feb">февраль</option>
                    <option value="mar">март</option>
                    <option value="apr">апрель</option>
                    <option value="may">май</option>
                    <option value="jun">июнь</option>
                    <option value="jul">июль</option>
                    <option value="aug">август</option>
                    <option value="sep">сентябрь</option>
                    <option value="oct">октябрь</option>
                    <option value="nov">ноябрь</option>
                    <option value="dec">декабрь</option>
                </select>
                <select id="endYear">
                    <option value="2015">2015</option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                </select>
                <input type="button" value="показать" onclick="callDisplayAuditoriumDateInterval()">
            </form>
            <form>
                <strong>добавить лекцию</strong>
                <br>дата:
                <br>
                <select id="lectureDay">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
                <select id="lectureMonth">
                    <option value="jan">январь</option>
                    <option value="feb">февраль</option>
                    <option value="mar">март</option>
                    <option value="apr">апрель</option>
                    <option value="may">май</option>
                    <option value="jun">июнь</option>
                    <option value="jul">июль</option>
                    <option value="aug">август</option>
                    <option value="sep">сентябрь</option>
                    <option value="oct">октябрь</option>
                    <option value="nov">ноябрь</option>
                    <option value="dec">декабрь</option>
                </select>
                <select id="lectureYear">
                    <option value="2015">2015</option>
                    <option value="2016">2016</option>
                    <option value="2017">2017</option>
                </select>
                <br>время:
                <br>
                <select id="lectureHour"></select>
                :
                <select id="lectureMinute"></select>
                <br>название:
                <br>
                <input id="lectureTitle" type="text">
                <br>лектор:
                <br>
                <input id="lecturerName" type="text">
                <br>информация о лекторе:
                <br>
                <input id="lecturerAbout" type="text">
                <br>школы:<br>
                <input id="schoolsInput" type="text" readonly="true">
                <br>студентов: <span id="studentsNumber">0</span>
                <br>
                <select id="lectureSchool"></select>
                <input type="button" value="добавить" onclick="addSchoolToInput()">
                <br>аудитория:
                <br>
                <select id="lectureAuditorium" onchange="displayCapacity()"></select>
                <br>вместимость: <span id="audCapacity"></span>
                <br>
                <input type="button" value="добавить" onclick="callAddLecture()">
            </form>
            <form>
                <strong>добавить школу</strong>
                <br>название:<br>
                <input id="newSchoolName" type="text">
                <br>количество студентов:<br>
                <input id="newSchoolStudents" type="number" min="1">
                <input type="button" value="добавить" onclick="callAddSchool()">
            </form>
            <form>
                <strong>добавить аудиторию</strong>
                <br>название:<br>
                <input id="newAuditoriumName" type="text">
                <br>вместимость:<br>
                <input id="newAuditoriumCapacity" type="number" min="1">
                <input type="button" value="добавить" onclick="callAddAuditorium()">
            </form>
        </div>
        <div id="schedule" class="schedule">
            <h1>Доклады</h1>
        </div>
    </div>
    <script>
    if (localStorage.getItem('auditoriums') === null) {
        localStorage.setItem('auditoriums', JSON.stringify(sampleAuditoriums));
    }

    if (localStorage.getItem('schools') === null) {
        localStorage.setItem('schools', JSON.stringify(sampleSchools));
    }

    if (localStorage.getItem('schoolsAcronyms') === null) {
        localStorage.setItem('schoolsAcronyms', JSON.stringify(sampleSchoolsAcronyms));
    }

    if (localStorage.getItem('lectures') !== null) {
        displayLectures();
    } else {
        for (var i = 0; i < sampleLectures.length; i++) {
            addLecture(new Date(sampleLectures[i].date), sampleLectures[i].title, sampleLectures[i].lecturer,
                sampleLectures[i].auditorium, sampleLectures[i].school);
        }
    }

    gatherDates();
    updateAuditoriumsSelect('auditoriumSelect');
    updateAuditoriumsSelect('lectureAuditorium');
    updateSchoolsSelect();
    fillTimeSelect();

    displayCapacity();

    function addSchoolToInput() {
        var schoolsInput = document.getElementById('schoolsInput');
        var school = document.getElementById('lectureSchool');
        var schoolName = school.options[document.getElementById('lectureSchool').selectedIndex].value;

        if (schoolsInput.value.indexOf(schoolName) !== -1) {
            alert('Школа уже добавлена');
            return;
        }

        if (schoolsInput.value === '') {
            schoolsInput.value += schoolName;
        } else {
            schoolsInput.value += ',' + schoolName;
        }

        var schools = JSON.parse(localStorage.getItem('schools'));
        var acronyms = JSON.parse(localStorage.getItem('schoolsAcronyms'));

        document.getElementById('studentsNumber').innerHTML =
            +document.getElementById('studentsNumber').innerHTML + schools[acronyms[schoolName]];
    }

    function displayCapacity() {
        var aud = document.getElementById('lectureAuditorium');
        var cap = document.getElementById('audCapacity');
        cap.innerHTML = JSON.parse(localStorage.getItem('auditoriums'))[aud.options[aud.selectedIndex].value];
    }

    function makeArrayByClassName(className) {
        var elements = document.getElementsByClassName(className);
        var array = [];
        for (var i = 0; i < elements.length; i++) {
            if (array.indexOf(elements[i].textContent.trim()) === -1) {
                array.push(elements[i].textContent.trim());
            }
        }
        return array;
    }

    function updateAuditoriumsSelect(selectId) {
        var select = document.getElementById(selectId);
        var auditoriums = JSON.parse(localStorage.getItem('auditoriums'));

        // clear select
        while (select.firstChild) {
            select.removeChild(select.firstChild);
        }

        if (selectId === 'auditoriumSelect') {
            var opt = document.createElement('option');
            opt.value = 'любая';
            opt.innerHTML = 'любая';
            select.appendChild(opt);
        }

        for (auditorium in auditoriums) {
            if (auditoriums.hasOwnProperty(auditorium)) {
                var option = document.createElement('option');
                option.value = auditorium;
                option.innerHTML = auditorium;
                select.appendChild(option);
            }
        }
    }

    function updateSchoolsSelect() {
        var select = document.getElementById('lectureSchool');
        var schools = JSON.parse(localStorage.getItem('schoolsAcronyms'));

        while (select.firstChild) {
            select.removeChild(select.firstChild);
        }

        for (school in schools) {
            if (schools.hasOwnProperty(school)) {
                var option = document.createElement('option');
                option.innerHTML = school;
                select.appendChild(option);
            }
        }
    }

    function fillTimeSelect() {
        var hour = document.getElementById('lectureHour');
        var minute = document.getElementById('lectureMinute');

        for (var i = 0; i < 24; i++) {
            var option = document.createElement('option');
            if (i > 9) {
                option.value = i;
                option.innerHTML = i;
            } else {
                option.value = '0' + i;
                option.innerHTML = '0' + i;
            }
            hour.appendChild(option);
        }
        for (var i = 0; i < 60; i++) {
            var option = document.createElement('option');
            if (i > 9) {
                option.value = i;
                option.innerHTML = i;
            } else {
                option.value = '0' + i;
                option.innerHTML = '0' + i;
            }
            minute.appendChild(option);
        }
    }

    function extractDates() {
        var dayStart = document.getElementById('startDay')
            .options[document.getElementById('startDay').selectedIndex].value;
        var monthStart = document.getElementById('startMonth')
            .options[document.getElementById('startMonth').selectedIndex].value;
        var yearStart = document.getElementById('startYear')
            .options[document.getElementById('startYear').selectedIndex].value;
        var dayEnd = document.getElementById('endDay')
            .options[document.getElementById('endDay').selectedIndex].value;
        var monthEnd = document.getElementById('endMonth')
            .options[document.getElementById('endMonth').selectedIndex].value;
        var yearEnd = document.getElementById('endYear')
            .options[document.getElementById('endYear').selectedIndex].value;

        return {
            dayStart: dayStart,
            monthStart: monthStart,
            yearStart: yearStart,
            dayEnd: dayEnd,
            monthEnd: monthEnd,
            yearEnd: yearEnd
        };
    }

    function callDisplayAuditoriumDateInterval() {
        var dates = extractDates();

        var startDate = new Date(dates['yearStart'] + '/' + dates['monthStart'] + '/' + dates['dayStart']);
        var endDate = new Date(dates['yearEnd'] + '/' + dates['monthEnd'] + '/' + dates['dayEnd']);
        var auditorium = document.getElementById('auditoriumSelect')
            .options[document.getElementById('auditoriumSelect').selectedIndex].value;

        displayAuditoriumDateInterval(auditorium, startDate, endDate);
    }

    function callAddLecture() {
        var day = document.getElementById('lectureDay')
            .options[document.getElementById('lectureDay').selectedIndex].value;
        var month = document.getElementById('lectureMonth')
            .options[document.getElementById('lectureMonth').selectedIndex].value;
        var year = document.getElementById('lectureYear')
            .options[document.getElementById('lectureYear').selectedIndex].value;
        var hour = document.getElementById('lectureHour')
            .options[document.getElementById('lectureHour').selectedIndex].value;
        var minute = document.getElementById('lectureMinute')
            .options[document.getElementById('lectureMinute').selectedIndex].value;
        var title = document.getElementById('lectureTitle').value;
        var lecturerName = document.getElementById('lecturerName').value;
        var lecturerAbout = document.getElementById('lecturerAbout').value;
        var school = document.getElementById('schoolsInput').value;
        var auditorium = document.getElementById('lectureAuditorium')
            .options[document.getElementById('lectureAuditorium').selectedIndex].value;

        var datetime = new Date(year + '/' + month + '/' + day + ' ' + hour + ':' + minute);
        var lecturer = {name: lecturerName, about: lecturerAbout};

        addLecture(datetime, title, lecturer, auditorium, school);
    }

    function callAddSchool() {
        var name = document.getElementById('newSchoolName').value;
        var studentsNumber = document.getElementById('newSchoolStudents').value;

        addSchool(name, studentsNumber);
        document.getElementById('newSchoolName').value = '';
        document.getElementById('newSchoolStudents').value = '';
        updateSchoolsSelect();
    }

    function callAddAuditorium() {
        var name = document.getElementById('newAuditoriumName').value;
        var capacity = document.getElementById('newAuditoriumCapacity').value;

        addAuditorium(name, capacity);
        document.getElementById('newAuditoriumName').value = '';
        document.getElementById('newAuditoriumCapacity').value = '';
        updateAuditoriumsSelect('lectureAuditorium')
    }
    </script>
</body>

</html>
